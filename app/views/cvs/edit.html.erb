<% content_for :head_tag do %>
<%= javascript_include_tag 'cvs.js' %>
<% end %>
<script type="text/javascript">
jQuery(document).ready(function($) {
    let TABKEY = 9;
    $(`div input`).keydown(function(event) {
        if (event.keyCode == TABKEY) {
            let $DIV,
                $INPUT = $(this),
                $NAME = $INPUT.val(),
                $CVID = $(`div.moncv:first`).attr('id');

            if ($INPUT.hasClass('skill')) {
                $DIV = $INPUT.parent('div#skills').children('div.tagHere:first');
                addSkill($DIV, $CVID, $NAME);

            } else if ($INPUT.hasClass('language')) {
                $DIV = $INPUT.parents('div#languages').children('div.tagHere:first');
                addLanguage($DIV, $CVID, $NAME);
            } else if ($INPUT.hasClass('programming_language')) {
                $DIV = $INPUT.parents('div#programming_languages').children('div.tagHere:first');
                addProgrammingLanguage($DIV, $CVID, $NAME);
            }

        }
    });

    $(`a.skill`).click(function(event) {
        event.preventDefault();

        let $ID = $(this).attr('id'),
            $DIV = $(this).parent('.tag:first'),
            $CVID = $(`div.moncv:first`).attr('id');

        removeSkill($DIV, $CVID, $ID);
    });

    $(`a.language`).click(function(event) {
        event.preventDefault();

        let $ID = $(this).attr('id'),
            $DIV = $(this).parent('.tag:first'),
            $CVID = $(`div.moncv:first`).attr('id');

        removeLanguage($DIV, $CVID, $ID);
    });

    $(`a.programming_language`).click(function(event) {
        event.preventDefault();

        let $ID = $(this).attr('id'),
            $DIV = $(this).parent('.tag:first'),
            $CVID = $(`div.moncv:first`).attr('id');

        removeProgrammingLanguage($DIV, $CVID, $ID);
    });

    $(`span.glyphicon`).click(function(event) {
        event.preventDefault();
        let $ITEM, $ID, $LEVEL;
        let parent = $(this).parent('div.tag:first');
        let siblings = parent.children('span.glyphicon');


        $ITEM = parent.hasClass('language') ? "languages" : "programming_languages";
        $ID = parent.attr('id');
        $LEVEL = Number(siblings.index(this)) + 1;

        for (let i = siblings.length - 1; i >= 0; i--) {
            if (siblings.index(siblings.eq(i)) <= siblings.index(this)) {
                siblings.eq(i).removeClass('glyphicon-star-empty');
                siblings.eq(i).addClass('glyphicon-star');
            } else {
                siblings.eq(i).removeClass('glyphicon-star');
                siblings.eq(i).addClass('glyphicon-star-empty');
            }
        }

        updateLevel($ITEM, $ID, $LEVEL);
    });

    $(`a.add-more`).click(function(event) {
        event.preventDefault();

        let $DIV = $(`div#${$(this).attr('for')}`),
            $NAME,
            $DESCRIPTION,
            $START,
            $END;

        console.log($DIV);
        console.log($NAME);
        console.log($DESCRIPTION);
        console.log($START);
        console.log($END);
    });

    function addSkill(div, cv_id, name) {
        if (name == "" || name == " ") { return false; } else {
            let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

            $.ajax({
                url: '/skills',
                type: 'POST',
                data: {
                    authenticity_token: AUTH_TOKEN,
                    cv_id: cv_id,
                    name: name
                },
            });
        }
    }

    function removeSkill(div, cv_id, id) {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        div.fadeOut('slow', function() {
            div.remove();
        });

        $.ajax({
            url: `/skills/${id}`,
            type: 'DELETE',
            data: {
                authenticity_token: AUTH_TOKEN,
                cv_id: cv_id,
                id: id
            },
        });
    }

    function addLanguage(div, cv_id, name) {
        if (name == "" || name == " ") { return false; } else {
            let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

            $.ajax({
                url: '/languages',
                type: 'POST',
                data: {
                    authenticity_token: AUTH_TOKEN,
                    cv_id: cv_id,
                    name: name
                },
            });
        }
    }

    function removeLanguage(div, cv_id, id) {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        div.fadeOut('slow', function() {
            div.remove();
        });

        $.ajax({
            url: `/languages/${id}`,
            type: 'DELETE',
            data: {
                authenticity_token: AUTH_TOKEN,
                cv_id: cv_id,
                id: id
            },
        });
    }

    function addProgrammingLanguage(div, cv_id, name) {
        if (name == "" || name == " ") { return false; } else {
            let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

            $.ajax({
                url: '/programming_languages',
                type: 'POST',
                data: {
                    authenticity_token: AUTH_TOKEN,
                    cv_id: cv_id,
                    name: name
                },
            });
        }
    }

    function removeProgrammingLanguage(div, cv_id, id) {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        div.fadeOut('slow', function() {
            div.remove();
        });

        $.ajax({
            url: `/programming_languages/${id}`,
            type: 'DELETE',
            data: {
                authenticity_token: AUTH_TOKEN,
                cv_id: cv_id,
                id: id
            },
        });
    }

    function updateLevel(item, id, level) {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        $.ajax({
            url: `/${item}/${id}`,
            type: 'PATCH',
            data: {
                authenticity_token: AUTH_TOKEN,
                id: id,
                level: level
            }
        });
    }

    function addExperience(div, name, description, start, end) {

    }


});
</script>
<div class="">
    <div id="<%=@cv.id%>" class="moncv cv container">
        <%= form_for @cv, method: :patch, html: {class: "updateCV", id: "updateCV"} do |f| %>
        <center>
            <h1>Mon Curriculum Vitae</h1>
        </center>
        <section class="row">
            <div class="avatar col-md-4">
                <% avatar = @student.sexe == 'Homme' ? 'profilh.png' : 'profilf.png' %>
                <div class="text-center">
                    <%= image_tag avatar, class: "img-thumbnail rounded float-left" %>
                </div>
            </div>
            <div class="summary right container col-md-8">
                <h2>
                    <%= f.label :summary, "Résumé" %>
                </h2>
                <div id="<%= @cv.id %>" class="summary field">
                    <%= f.text_area :summary, value: @cv.summary, class: "form-control" %>
                </div>
            </div>
        </section>
        <!-- <hr> -->
        <section class="row">
            <div class="student_infos col-md-5">
                <h2>
                    <%= f.text_field :developer_type, class: "form-control" %>
                </h2>
                <table class="table table-primary">
                    <tr>
                        <th>Nom complet</th>
                        <td>
                            <%= @student.lastname %>
                            <%= @student.firstname %>
                        </td>
                    </tr>
                    <tr>
                        <th>Date de naissance</th>
                        <td>
                            <%= @student.birthdate.strftime("%B %d, %Y") %>
                        </td>
                    </tr>
                    <tr>
                        <th>Contact</th>
                        <td>
                            <%= @student.tel %>
                        </td>
                    </tr>
                    <tr>
                        <th>Addresse</th>
                        <td>
                            <%= @student.address %>
                        </td>
                    </tr>
                    <tr>
                        <th>Sexe</th>
                        <td>
                            <%= @student.sexe %>
                        </td>
                    </tr>
                    <tr>
                        <th>Etat civil</th>
                        <td>
                            <%= @student.marital_status %>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="experiences" class="right col-md-7">
                <h2><label for="experience_name">Experiences</label></h2>
                <div class="tagHere experiences" style="display: block; border:1px solid red;">
                    <% @cv.experiences.each do |ex| %>
                    <% if ex %>
                    <div id="<%= ex.id %>" class="experience">
                        <div class="name">
                            <%= ex.name %>
                        </div>
                        <div class="date">
                            <%= ex.start_date.strftime("%B %N") %>
                            <%= ex.end_date.strftime("%B %N") %>
                        </div>
                        <div class="description">
                            <%= ex.description %>
                        </div>
                    </div>
                    <% end %>
                    <% end %>
                    <div id="0" class="experience">
                        <div class="name">
                            <span>Rédacteur en chef</span>
                        </div>
                        <div class="date">
                            <label>Du</label>
                            <span>
                                <%= (Time.now - 3600*24*30*2).strftime("%B %Y") %></span>
                            <label>au</label>
                            <span>
                                <%= Time.now.strftime("%B %Y") %></span>
                        </div>
                        <div class="description">
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
                                tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
                                quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
                                consequat.
                            </p>
                        </div>
                    </div>
                </div>
                <div id="1" class="experience">
                    <div class="name">
                        <input type="text" id="experience_name" name="experience[name]">
                    </div>
                    <div class="date">
                        <label for="experience_start_date">Du</label>
                        <input type="date" id="experience_start_date" name="experience[start_date]">
                        <label for="experience_start_date">au</label>
                        <input type="date" id="experience_end_date" name="experience[end_date]">
                    </div>
                    <div class="description">
                        <textarea maxlength="180" class="form-control"></textarea>
                    </div>
                </div>
                <div class="">
                    <a href="#" for="experiences" class="add-more btn btn-primary"><i class="fas fa-plus"></i></a>
                </div>
            </div>
        </section>
        <!-- <hr> -->
        <section class="row">
            <div class="col-md-5">
                <h2><label for="programming_language_name">Connaissances Techniques</label></h2>
                <!--  -->
                <div class="" id='programming_languages'>
                    <div class='tagHere programming_languages'>
                        <% @cv.programming_languages.each do |programming_language| %>
                        <% if programming_language %>
                        <div id="<%= programming_language.id %>" class="tag programming_language">
                            <a href="#" class="programming_language" id="<%=programming_language.id%>"><i class="fa fa-times" aria-hidden="true"></i></a>
                            <span>
                                <%=programming_language.name%></span>
                            <% programming_language.level.times do |id| %>
                            <span class="glyphicon glyphicon-star" style="color: gold;"></span>
                            <% end %>
                            <% (7 - programming_language.level.to_i).times do |id| %>
                            <span class="glyphicon glyphicon-star-empty" style="color: gold;"></span>
                            <% end %>
                        </div>
                        <% end %>
                        <% end %>
                    </div>
                    <input id="programming_language_name" class="programming_language" type="text" />
                </div>
                <!--  -->
            </div>
            <div class="right col-md-7">
                <h2><label for="skill_name">Compétences</label></h2>
                <!--  -->
                <div class="" id='skills'>
                    <div class='tagHere skills'>
                        <% @cv.skills.each do |skill| %>
                        <% if skill %>
                        <div class="tag skill">
                            <a href="#" class="skill" id="<%=skill.id%>"><i class="fa fa-times" aria-hidden="true"></i></a>
                            <span>
                                <%=skill.name%></span>
                        </div>
                        <% end %>
                        <% end %>
                    </div>
                    <input id="skill_name" class="skill" type="text" />
                </div>
                <!--  -->
            </div>
        </section>
        <section class="row">
            <div class="col-md-5">
                <h2><label for="language_name">Language</label></h2>
                <!--  -->
                <div class="" id='languages'>
                    <div class='tagHere languages'>
                        <% @cv.languages.each do |language| %>
                        <% if language %>
                        <div id="<%= language.id %>" class="tag language">
                            <a href="#" class="language" id="<%=language.id%>"><i class="fa fa-times" aria-hidden="true"></i></a>
                            <span>
                                <%=language.name%></span>
                            <% language.level.times do |id| %>
                            <span class="glyphicon glyphicon-star" style="color: gold;"></span>
                            <% end %>
                            <% (7 - language.level.to_i).times do |id| %>
                            <span class="glyphicon glyphicon-star-empty" style="color: gold;"></span>
                            <% end %>
                        </div>
                        <% end %>
                        <% end %>
                    </div>
                    <input id="language_name" class="language" type="text" />
                </div>
                <!--  -->
            </div>
            <div class="right col-md-7">
                <h2>
                    <%= f.label :experiences, "Educations" %>
                </h2>
                <div class="experiences row" style="display: block;">
                    <% @cv.experiences.each do |ex| %>
                    <% if ex %>
                    <div id="experience<%= ex.id %>" class="field experience old form-group col-md-4 row">
                        <input type="text" id="exp<%= ex.id %>0" name="expnames[name<%= ex.id %>]" class="form-control" value="<%= ex.name %>">
                        <div class="actions collapse row">
                            <div class="col-md-10" style="padding: 0 0 0 2%;">
                                <textarea id="exp<%= ex.id %>1" name="expdescriptions[description<%= ex.id %>]" class="level form-control col-md-10"><%= ex.description %></textarea>
                            </div>
                            <div class="col-md-2" style="padding: 0 0 0 2%;">
                                <a id="rmexperience<%= ex.id %>" class="remove-me"><i class="fa fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    <% end %>
                    <% end %>
                </div>
                <div class="">
                    <a href="#" id="experiences" class="add-more btn btn-primary"><i class="fas fa-plus"></i></a>
                </div>
            </div>
        </section>
        <section class="row">
            <div class="col-md-5"></div>
            <div class="right col-md-7">
                <div class="hobbies">
                    <h2>
                        <%= f.label :hobbies, "Passe temps" %>
                    </h2>
                    <div id="<%= @cv.id %>" class="field hobbies">
                        <%= f.text_area :hobbies, value: @cv.hobbies, class: "form-control" %>
                    </div>
                </div>
            </div>
        </section>
        <hr>
        <% end %>
    </div>
</div>