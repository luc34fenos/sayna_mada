<% content_for :head_tag do %>
<%= javascript_include_tag 'cvs.js' %>
<% end %>

<script type="text/javascript">
  jQuery(document).ready(function($) {
    let TABKEY = 9;
    $(`div input`).keydown(function(event) {
        if (event.keyCode == TABKEY) {
            let $DIV,
                $INPUT = $(this),
                $NAME = $INPUT.val(),
                $CVID = $(`div.moncv:first`).attr('id');

            if ($INPUT.hasClass('skill')) {
                $DIV = $INPUT.parent('div#skills').children('div.tagHere:first');
                addSkill($DIV, $CVID, $NAME);

            } else if ($INPUT.hasClass('language')) {
                $DIV = $INPUT.parents('div#languages').children('div.tagHere:first');
                addLanguage($DIV, $CVID, $NAME);
            }

        }
    });

    $(`a.skill`).click(function(event) {
      event.preventDefault();

      let $ID = $(this).attr('id'),
        $DIV = $(this).parent('.tag:first'),
        $CVID = $(`div.moncv:first`).attr('id');

        removeSkill($DIV, $CVID, $ID);
    });

    $(`a.language`).click(function(event) {
      event.preventDefault();

      let $ID = $(this).attr('id'),
        $DIV = $(this).parent('.tag:first'),
        $CVID = $(`div.moncv:first`).attr('id');

        removeLanguage($DIV, $CVID, $ID);
    });

    $(`span.glyphicon`).click(function(event) {
            
    });

    function addSkill(div, cv_id, name) {
      if (name == "" || name == " ") { return false; }
      else {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        $.ajax({
          url: '/skills',
          type: 'POST',
          data: {
            authenticity_token: AUTH_TOKEN,
            cv_id: cv_id,
            name: name
          },
        });
      }
    }

    function removeSkill(div, cv_id, id){
      let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        div.fadeOut('slow', function() {
          div.remove();
        });
        
        $.ajax({
          url: `/skills/${id}`,
          type: 'DELETE',
          data: {
            authenticity_token: AUTH_TOKEN,
            cv_id: cv_id,
            id: id
          },
        });
    }

    function addLanguage(div, cv_id, name) {
      if (name == "" || name == " ") { return false; }
      else {
        let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        $.ajax({
          url: '/languages',
          type: 'POST',
          data: {
            authenticity_token: AUTH_TOKEN,
            cv_id: cv_id,
            name: name
          },
        });
      }
    }

    function removeLanguage(div, cv_id, id){
      let AUTH_TOKEN = $(`input[name="authenticity_token"]`).attr('value');

        div.fadeOut('slow', function() {
          div.remove();
        });
        
        $.ajax({
          url: `/languages/${id}`,
          type: 'DELETE',
          data: {
            authenticity_token: AUTH_TOKEN,
            cv_id: cv_id,
            id: id
          },
        });
    }

    function updateLevel(item, id, level) {

    }


  }); 
</script>

<center>
    <h1 style="text-decoration: underline; text-transform: uppercase;">student 1</h1>
</center>
<div class="links">
    <nav class="nav flex-column">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <%= link_to "Aperçu", "/moncv/#{@cv.id}", method: :get, class: "nav-link" %>
            </li>
            <li class="nav-item">
                <%= link_to "Editer", "/moncv/#{@cv.id}/edit", method: :get, class: "nav-link active" %>
            </li>
            <li class="nav-item">
                <a class="update nav-link" href="#" id="update">Maj</a>
            </li>
        </ul>
    </nav>
</div>
<div class="">
    <div id="<%=@cv.id%>" class="moncv container">
        <%= form_for @cv, method: :patch, html: {class: "updateCV", id: "updateCV"} do |f| %>
        <center>
            <h1>Mon Curriculum Vitae</h1>
        </center>
        <section class="row">
            <div class="avatar col-md-4">
                <% avatar = @student.sexe == 'Homme' ? 'profilh.png' : 'profilf.png' %>
                <div class="text-center">
                    <%= image_tag avatar, class: "img-thumbnail rounded float-left" %>
                </div>
            </div>
            <div class="summary right container col-md-8">
                <h2>
                    <%= f.label :summary, "Résumé" %>
                </h2>
                <div id="<%= @cv.id %>" class="summary field">
                    <%= f.text_area :summary, value: @cv.summary, class: "form-control" %>
                </div>
            </div>
        </section>
        <!-- <hr> -->
        <section class="row">
            <div class="student_infos col-md-5">
                <h2>
                    <%= f.text_field :developer_type, class: "form-control" %>
                </h2>
                <table class="table table-primary">
                    <tr>
                        <th>Nom complet</th>
                        <td>
                            <%= @student.lastname %>
                            <%= @student.firstname %>
                        </td>
                    </tr>
                    <tr>
                        <th>Date de naissance</th>
                        <td>
                            <%= tag.time l(@student.birthdate, format: :long) %>
                        </td>
                    </tr>
                    <tr>
                        <th>Contact</th>
                        <td>
                            <%= @student.tel %>
                        </td>
                    </tr>
                    <tr>
                        <th>Addresse</th>
                        <td>
                            <%= @student.address %>
                        </td>
                    </tr>
                    <tr>
                        <th>Sexe</th>
                        <td>
                            <%= @student.sexe %>
                        </td>
                    </tr>
                    <tr>
                        <th>Etat civil</th>
                        <td>
                            <%= @student.marital_status %>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="right col-md-7">
                <h2>
                    <%= f.label :experiences, "Experiences" %>
                </h2>
                <div class="experiences row" style="display: block;">
                    <% @cv.experiences.each do |ex| %>
                    <% if ex %>
                    <div id="experience<%= ex.id %>" class="field experience old form-group col-md-4 row">
                        <input type="text" id="exp<%= ex.id %>0" name="expnames[name<%= ex.id %>]" class="form-control" value="<%= ex.name %>">
                        <div class="actions collapse row">
                            <div class="col-md-10" style="padding: 0 0 0 2%;">
                                <textarea id="exp<%= ex.id %>1" name="expdescriptions[description<%= ex.id %>]" class="level form-control col-md-10"><%= ex.description %></textarea>
                            </div>
                            <div class="col-md-2" style="padding: 0 0 0 2%;">
                                <a id="rmexperience<%= ex.id %>" class="remove-me"><i class="fa fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    <% end %>
                    <% end %>
                </div>
                <div class="">
                    <a href="#" id="experiences" class="add-more btn btn-primary"><i class="fas fa-plus"></i></a>
                </div>
            </div>
        </section>
        <!-- <hr> -->
        <section class="row">
            <div class="col-md-5">
                <h2>
                    <%= f.label :programming_languages, "Connaissances Techniques" %>
                </h2>
                <div class="programming_languages row">
                    <% @cv.programming_languages.each do |programming_language| %>
                    <% if programming_language %>
                    <div id="programming_language<%= programming_language.id %>" class="field programming_language form-group col-md-4 row old">
                        <input type="text" id="programming_language<%= programming_language.id %>0" name="programming_languagenames[name<%= programming_language.id %>]" class="form-control" value="<%= programming_language.name %>">
                        <div class="actions collapse row">
                            <div class="col-md-10" style="padding-left: 0;">
                                <% programming_language.level.to_i.times do  %>
                                <span class="glyphicon glyphicon-star col-md-2" style="padding-left: 5%;position: relative;top: 2px;margin: 0 1%; color: gold;"></span>
                                <% end %>
                                <% (5-programming_language.level.to_i).times do  %>
                                <span class="glyphicon glyphicon-star-empty col-md-2" style="padding-left: 5%;position: relative;top: 2px;margin: 0 1%; color: gold;"></span>
                                <% end %>
                            </div>
                            <div class="col-md-2" style="padding: 0;">
                                <a id="rmprogramming_language<%= programming_language.id %>" class="remove-me"><i class="fa fa-trash"></i></a>
                            </div>
                        </div>
                    </div>
                    <% end %>
                    <% end %>
                </div>
                <a href="#" id="programming_languages" class="add-more btn btn-primary"><i class="fas fa-plus"></i></a>
            </div>
            <div class="right col-md-7">
                <h2>
                    <%= f.label :skills, "Compétences" %>
                </h2>
                <!--  -->
                <div class="" id='skills'>
                    <div class='tagHere skills'>
                    <% @cv.skills.each do |skill| %>
                    <% if skill %>
                      <div class="tag skill">
                        <a href="#" class="skill" id="<%=skill.id%>"><i class="fa fa-times" aria-hidden="true"></i></a>
                        <span><%=skill.name%></span>
                      </div>
                    <% end %>
                    <% end %>
                    </div>
                    <input class="skill" type="text" />
                </div>
                <!--  -->
            </div>
        </section>
        <section class="row">
            <div class="col-md-5">
                <h2>
                    <%= f.label :languages, "Langues" %>
                </h2>
                <!--  -->
                <div class="" id='languages'>
                    <div class='tagHere languages'>
                    <% @cv.languages.each do |language| %>
                    <% if language %>
                      <div class="tag language">
                        <a href="#" class="language" id="<%=language.id%>"><i class="fa fa-times" aria-hidden="true"></i></a>
                        <span><%=language.name%></span>
                        <% language.level.times do |id| %>
                          <span class="glyphicon glyphicon-star" style="color: gold;"></span>
                        <% end %>
                        <% (7 - language.level.to_i).times do |id| %>
                          <span class="glyphicon glyphicon-star-empty"></span>
                        <% end %>
                      </div>
                    <% end %>
                    <% end %>
                    </div>
                    <input class="language" type="text" autofocus />
                </div>
                <!--  -->
            </div>
            <div class="right col-md-7">
                <div class="hobbies">
                    <h2>
                        <%= f.label :hobbies, "Passe temps" %>
                    </h2>
                    <div id="<%= @cv.id %>" class="field hobbies">
                        <%= f.text_area :hobbies, value: @cv.hobbies, class: "form-control" %>
                    </div>
                </div>
            </div>
        </section>
        <hr>
        <% end %>
    </div>
</div>
